<!-- Generated by SpecStory -->

# 创建项目使用指南 (2025-08-14 01:29Z)

_**User**_

仔细阅读我的项目，为我的项目创建一份使用指南，具体参考xhs_example_v2.py及其导入的一系列文件，不用管xhs_example.py了。用中文

---

_**Assistant**_

<think><details><summary>Thought Process</summary>**Creating a usage guide**

I need to create a usage guide for the user's project in Chinese. The user wants me to focus on xhs_example_v2.py and its imports while ignoring xhs_example.py. My plan is to read xhs_example_v2.py and the modules it imports. I’ll likely include installation, environment setup, account handling, how to run examples, and configuration details. I should also check src/__main__.py, src/services/xiaohongshu, and any relevant documentation like README.md to ensure I cover everything necessary. I'll outline clear steps for installation and configuration.
**Reading relevant files**

I’m following the developer tool usage by starting with a status update before using parallel tool calls to read the necessary files. First, I'll look at xhs_example_v2.py, along with src/plugins/xiaohongshu_v2.py. I also want to check the plugin registry, base components, and services/xiaohongshu components. Additionally, I’ll review settings.py for configuration details and examples/xiaohongshu_services_example.py for similarities, but my main focus will remain on xhs_example_v2. I’m planning to do these reads in parallel.</details></think>

---

我会先浏览 `xhs_example_v2.py` 以及它依赖的核心模块，梳理运行步骤与配置点，并整理成一份清晰的中文使用指南。现在开始读取关键文件。

---

Read file: undefined

---

Read file: undefined

---

Read file: undefined

---

Read file: undefined

---

Read file: undefined

---

<think><details><summary>Thought Process</summary>**Investigating login issue**

It seems like I’m facing a bug where _manual_login is returning False. After calling wait_until_result, it still returns False. However, fetch uses _ensure_logged_in to guarantee a login, but I haven’t looked into the _ensure_logged_in function. It might be attempting a cookie login and a manual login within the plugin base. I think I should read through the BasePlugin code to understand better what's going on here.</details></think>

---

我将继续快速阅读与示例强相关的核心类与服务定义，以便写出完整、准确的中文使用指南：`EverythingAsInterface`、`TaskConfig`、`Scheduler`、`PluginManager`、`AccountManager`、`SubscriptionSystem`、`PluginContext`、以及小红书服务的核心参数类型。随后我会直接输出整理好的指南。

---

Read file: undefined

---

Read file: undefined

---

Read file: undefined

---

Read file: undefined

---

Read file: undefined

---

<think><details><summary>Thought Process</summary>**Creating a Chinese Usage Guide**

I need to produce a guide for the project, specifically for documenting how to use xhs_example_v2.py and its imported files based on a request. The guide should include installation requirements, account paths, the master key, and how to run the script. I’ll cover config fields, plugin ID, task types, scheduling, subscription systems, manual login, cookie management, and account structure. Additionally, I’ll address plugin details and various parameters for comments and tasks.
**Reviewing Plugin Services and Documentation Needs**

I'm noticing references to `_search_service` and `_detail_service`, but it seems they're not imported in the plugin v2 file, meaning the search and details functionalities might not work as expected. Instead, only `_note_net_service`, `_comment_service`, and `_note_brief_net_service` are configured. So, I should document that currently, only favorites, briefs, and comments are supported, while search and details require additional services. I also need to include OS support details and installation instructions for dependencies.
**Clarifying Playwright Installation**

I need to clarify that Playwright for Python requires running 'playwright install' to set up the necessary browsers. Although my code launches the Edge channel through `playwright.chromium.launch(channel=msedge)`, it still relies on having Edge installed on the system. While 'playwright install' is generally needed for default browser setup, in this case, it might be optional since Chrome/Edge is already there. I'll instruct users to run 'pip install -r requirements-dev.txt' and 'python -m playwright install' for complete support. I should also check the dependencies in requirements-dev.txt.</details></think>

---

Read file: undefined

---



---

我将并行打开与小红书服务和集合逻辑相关的文件，确定 `TaskConfig.extra` 支持的关键参数与运行前提，这样写出的指南可操作性更强。随后直接输出完整中文指南。

---

Read file: undefined

---

Read file: undefined

---

Read file: undefined

---

Read file: undefined

---

Read file: undefined

---

Read file: undefined

---



---

Read file: undefined

---



---

Read file: undefined

---

<think><details><summary>Thought Process</summary>**Installing Playwright with Edge**

To get started with Playwright, I need to install it with the Microsoft Edge channel. On Windows, setting the channel to "msedge" ensures it uses the installed Edge browser. While I don’t need to run the Playwright install for browsers in “channel” mode, I might need to check for WebKit binaries. 

The steps include ensuring Python 3.9 or greater is installed, using `pip install -r requirements-dev.txt`, and confirming that Edge is installed, or changing to "chrome" if necessary. I need to prepare the accounts folder, set up the master key, and then run initially to log in manually.
**Saving Cookie IDs and Running Tasks**

To save the cookie ID after manual login, I see the log shows "Cookie 已保存: <id>," so I need to copy that into the example config.

Next, to run the example, I would use `python xhs_example_v2.py`. I can switch task types for favorites or briefs by using the `.user`, `.side-bar-component`, and `.sub-tab-list:nth-child(2)`, but the site layout might change.

For comments, I’ll set `note_id`, `max_comment_pages`, and `comment_delay_ms`. The output should confirm with “success” and include a data list. 

The subscription system creates a topic for new favorites, while video downloading and some headless parameters can be addressed further, primarily focusing on how to set headless mode in the orchestrator with its own parameter.
**Understanding Scheduler Settings**

The scheduler orchestrator's `allocate_context_page` does not work in headless mode; that parameter is for when the orchestrator starts. I need to set it using `orchestrator.start(headless=True)`. In the example, the headless parameter is set to False.

Regarding debug tips, if I see "插件不存在: xiaohongshu_v2," it may indicate the plugin isn't registered. The plugin is registered via the decorator at the bottom, but registration occurs when the module is imported. Also, the orchestrator’s proxy parameter allows passing proxies easily.

I can change the interval for checks, which defaults to every 5 minutes, and mention that the scheduler doesn’t automatically save data. We'll provide runnable code snippets as examples within code fences, without editing the actual code.
**Configuring Playwright and Cookie Management**

I want to provide short code examples for configuration. It's important to caution users that if they're using the `cookie_ids` list, these IDs must exist in `accounts/cookies.enc`. The `AccountManager` merges cookies from various platforms, but for Xiaohongshu specifically, the `platform_id` must be 'xiaohongshu'.

Additionally, I need to add steps for installing Playwright dependencies. Running "playwright install" is necessary to download the drivers. Even when using system browsers via the channel, Playwright requires an installed driver. The Python package includes the driver, but when working through the channel setup, I can also run "python -m playwright install" for added clarity.</details></think>

---

### 使用指南（基于 `xhs_example_v2.py`）

本指南围绕 `xhs_example_v2.py` 及其导入的核心模块，帮助你快速完成安装、登录与任务调度，获取小红书收藏流的数据。无需关注 `xhs_example.py`。

### 适用范围
- 仅覆盖 `xiaohongshu_v2` 插件和它使用的服务：`note_net`（详情流）、`note_brief_net`（摘要流/卡片）、`comments`（评论）。
- 当前实现稳定支持的 `task_type`：`favorites` 与 `briefs`（收藏流采集），`comments`（评论采集）。
- 代码中存在占位但未初始化的能力：`search` 与 `details` 尚未注入对应服务，建议暂不使用。

### 环境要求
- Python 3.9+（推荐 3.10/3.11）
- Windows 10/11，已安装 Microsoft Edge（或改用 Chrome）
- 依赖：Playwright、cryptography、httpx、pytest 相关等（见 `requirements-dev.txt`）

### 安装
- 安装依赖：
```bash
pip install -r requirements-dev.txt
python -m playwright install
```
- 如使用本机 Edge 控制浏览器（默认 `channel="msedge"`），可不安装浏览器二进制；如改用 Chrome，将 Orchestrator 的 `channel` 改为 `"chrome"`。

### 首次运行与登录
- 运行示例（会启动浏览器，首轮需手动登录）：
```bash
python xhs_example_v2.py
```
- 首次运行流程：
  - 系统初始化 `EverythingAsInterface`，本地创建 `accounts/` 与 `data/` 目录。
  - 调度器添加 `xiaohongshu_v2` 任务，默认每 5 分钟执行一次。
  - 首次无 Cookie 时，插件会引导你打开登录页；完成登录后系统自动保存 Cookie 到 `accounts/cookies.enc`（加密存储）。
  - 控制台会打印“Cookie 已保存: <cookie_id>”。将该 `cookie_id` 复制到任务配置的 `cookie_ids`，后续运行可免登录。

- 二次运行（免登录）：
  - 在 `TaskConfig(cookie_ids=[...])` 中填写刚才保存的 `cookie_id`，程序会自动注入 Cookie 并校验是否已登录。

### 任务与调度模型
- `Scheduler.add_task(plugin_id="xiaohongshu_v2", interval=300, config=TaskConfig(...))`
  - `interval`：单位秒。
  - 任务回调将数据发布到订阅系统的主题，`on_new_favorite` 示例会打印新增收藏条目标题。
- 浏览器编排由 `Orchestrator` 负责（Playwright）。示例中：
  - `await orchestrator.start(headless=False)`：可改成 `True` 实现无头模式。
  - 如需代理：`await orchestrator.start(proxy={"server": "http://host:port", "username": "...", "password": "..."})`。

### 可用任务类型与关键配置

- 通用配置容器：`TaskConfig`
  - 常用字段：`headless`、`cookie_ids`、`viewport`、`user_agent`、`extra_http_headers`、`interval`
  - 插件自定义字段放在 `extra` 中（字典）

- `task_type="favorites"`（详情流）
  - 返回项类型：`NoteDetailsItem`
  - 关键 `extra`：
    - `max_items`：最大采集条数（默认 1000）
    - `max_seconds`：最大持续秒数（默认 600）
    - `max_idle_rounds`：空转轮数上限（默认 2）
    - `auto_scroll`：是否自动滚动（默认 True）
    - `scroll_pause_ms`：滚动暂停毫秒（默认 800）
    - 可选停止条件：`stop_on_tags`、`stop_on_author`、`stop_on_title_keywords`
  - 站点导航：自动点击进入“收藏”页（依赖选择器，站点更新可能需调整）

- `task_type="briefs"`（摘要卡片流）
  - 返回项类型：`NoteBriefItem`
  - `extra` 支持同上（滚动、限额、空转轮数等）
  - 站点导航：同“收藏”页

- `task_type="comments"`（评论）
  - 必填：`extra.note_id`（笔记 ID）
  - 可选：`max_comment_pages`、`comment_delay_ms`
  - 返回项类型：`CommentItem`
  - 注意：演示代码中打开详情页与翻页是占位方法（`_open_note_and_show_comments` / `_load_next_comments_page`），如要真实抓取需在服务中补齐触发逻辑（比如点击“评论”按钮、处理“更多评论”）。

### 最小可用示例（一键跑通收藏摘要）
```python
# 片段示意：将 xhs_example_v2.py 中 TaskConfig 的 extra 改为更小量测试
TaskConfig(
    cookie_ids=["<你的cookie_id>"],  # 首次登录后在控制台看见
    extra={
        "task_type": "briefs",      # 或 "favorites"
        "max_items": 20,
        "max_seconds": 120,
        "scroll_pause_ms": 600
    }
)
```

### 控制浏览器与代理（可选）
```python
# 用 Chrome 而非 Edge
orchestrator = Orchestrator(channel="chrome")
await orchestrator.start(headless=True)  # 无头运行

# 走代理
orchestrator = Orchestrator(proxy={"server": "http://127.0.0.1:7890"})
await orchestrator.start(headless=False)
```

### 返回数据结构（示例）
- `briefs`：
```json
{
  "success": true,
  "data": [
    {
      "id": "xxxx",
      "xsec_token": "xxxx",
      "title": "标题",
      "author_info": {"user_id":"...", "username":"...", "avatar":"...", "xsec_token":"..."},
      "statistic": {"like_num":"123", "collect_num":null, "chat_num":null},
      "cover_image": "https://..."
    }
  ],
  "count": 1,
  "plugin_id": "xiaohongshu_v2",
  "version": "2.0.0",
  "task_type": "favorites"
}
```
- `favorites`（详情流，字段更丰富，如 `images`、`ip_zh` 等）与 `comments` 返回格式类似，仅数据项结构不同。

### 常见问题与排查
- 插件未找到或未注册
  - 确认已导入 `src/plugins/xiaohongshu_v2.py`（示例里 `from src.plugins.xiaohongshu_v2 import XiaohongshuV2Plugin` 会触发注册）
- 需要重新登录
  - 控制台出现 “检测到需要重新登录”，按提示在浏览器中完成登录；成功后会再次保存新的 Cookie ID
- Cookie 未生效
  - 确认 `cookie_ids` 为有效且未过期；`AccountManager` 会合并与校验，80% 以上过期会视为失效
- 浏览器无法启动或白屏
  - 运行 `python -m playwright install`
  - Edge 未安装时，改用 `channel="chrome"` 并确保本机有 Chrome
- 页面结构变化导致采集不到数据
  - 收藏页点击路径使用选择器：`.user, .side-bar-component` → `.sub-tab-list:nth-child(2)`。如站点更新需在 `XiaohongshuV2Plugin` 中调整

### 目录与持久化
- `accounts/`：加密存储 Cookie（`cookies.enc`），平台定义（`platforms.json`）
- `data/`：你可在任务回调中自行落地 JSON/CSV/DB
- `everything-as-an-interface.log`：运行日志

### 安全提示
- `EverythingAsInterface(config={"master_key": "your-secret-key"})` 用于本地 Cookie 加密；生产请安全保存主密钥，并避免硬编码。

- - -

- 我已阅读 `xhs_example_v2.py` 及其关联的插件、调度、账号与服务代码，整理了安装、登录与任务配置指南，并明确了当前可用的 `task_type` 与参数、浏览器与代理控制、以及常见问题排查。

---

_**User**_

ok，写文档内容写入到本地md文件中

---

_**Assistant**_

<think><details><summary>Thought Process</summary>**Writing usage guide**

I need to write the usage guide into a local markdown file within the repository. I'll use editing tools as instructed, creating a new document, probably named docs/USAGE_XHS_V2.md in Chinese. I’ll use apply_patch to add the file while ensuring markdown formatting with headers. Before making changes, I'll provide a brief status update and then run the tools. After editing, I won’t need to run lints since it’s documentation. Lastly, I’ll summarize the steps taken.
**Creating usage documentation**

I'm set to use functions.apply_patch to add a new file. I need to prepare content similar to previous documentation, making sure it includes code fences for commands. The filename could be docs/USAGE_XHS_V2.md or docs/小红书使用指南_xhs_example_v2.md—though I prefer an ASCII path. I'll include sections with headings, starting with "## 使用指南（基于 xhs_example_v2.py）". Also, I need to ensure minor corrections, like updating the "task_type" in the JSON example to "favorites" for clarity.
**Addressing potential bug in plugin code**

In the plugin code, specifically in _collect_briefs, it seems to return "task_type": "favorites," which might be a bug since it maps this even for briefs. To clarify, I should note that "task_type" shows as favorites, but for accuracy, I’ll mention that in xiaohongshu_v2._collect_briefs, it specifically sets "task_type": "favorites." I’ll add a small note about this implementation detail. I’ll also include commands to run Playwright install and address the Edge channel configuration. Now, I’ll call apply_patch to add the file.</details></think>

---

我将把刚才整理的中文使用指南保存为仓库中的一个 Markdown 文档，放在 `docs/USAGE_XHS_V2.md`，便于你在本地或 CI 文档站点中查看和维护。现在开始写入文件。

---



---



---



---

