# å¼€å‘è€… SOP
[toc]

## æœ€ä½³å®è·µ
* **æ•°æ®é‡‡é›†åˆ†è¿‡ç¨‹ï¼Œä¸è¦ä¸€æ¬¡å°±æ‹¿ä¸‹è¯¦ç»†æ•°æ®ï¼ï¼ï¼ï¼**ï¼ˆè¿™ç‚¹æœ€æœ€æœ€æœ€æœ€æœ€å…³é”®ï¼ï¼ï¼ï¼‰
  * æ¯”å¦‚å°çº¢ä¹¦ç¬”è®°æ•°æ®é‡‡é›†ï¼Œå¯ä»¥å…ˆé€šè¿‡ç€‘å¸ƒæµè·å–ç®€ç•¥çš„ç¬”è®°ä¿¡æ¯ï¼Œä¸€æ¡ç¬”è®°ç”±note_idå’Œxsec_tokenç¡®å®šï¼Œä½ è‡³å°‘éœ€è¦ä¿è¯è¿™ä¸¤æ¡æ•°æ®åˆ°æ‰‹ã€‚
  * æ¥ä¸‹æ¥ï¼Œåˆ©ç”¨è·å–ç¬”è®°è¯¦æƒ…æ’ä»¶ï¼Œæ¥ä¸æ–­çš„çˆ¬å–ç¬”è®°çš„è¯¦æƒ…æ•°æ®ï¼

## 0. ç›®æ ‡è¯»è€…
* ä»…â€œä½¿ç”¨æ’ä»¶â€çš„å¼€å‘è€…ï¼šåªéœ€è¦ç”¨ RPC å®¢æˆ·ç«¯/REST å¿«é€Ÿæ¥å…¥ï¼Œé˜…è¯»`README.md`å³å¯
* æ‰©å±•èƒ½åŠ›çš„å¼€å‘è€…ï¼šæ–°å¢æ’ä»¶ã€æ²‰æ·€æœåŠ¡ã€æ‰“ç£¨åŒæ­¥ä¸å¯é æ€§ï¼ŒåŒæ ·éœ€è¦å…ˆé˜…è¯»`README.md`å³å¯

## 1. æˆ‘ä»¬çš„çˆ¬è™«æ˜¯å¦‚ä½•è¿ä½œçš„ï¼ˆé‡è¦ï¼‰

æˆ‘ä»¬çš„çˆ¬è™«æ ¸å¿ƒåŸºäº **Playwright è‡ªåŠ¨åŒ–æµ‹è¯•å·¥å…·**ã€‚é€šè¿‡å®ƒï¼Œæˆ‘ä»¬å¯ä»¥æ¨¡æ‹ŸçœŸå®ç”¨æˆ·æ‰“å¼€ç½‘é¡µï¼Œå¹¶åˆ©ç”¨å…¶å¯¹ **DOM æ“ä½œ** å’Œ **ç½‘ç»œè¯·æ±‚/å“åº”ç›‘å¬** çš„èƒ½åŠ›ï¼Œæ„å»ºæ‰€éœ€çš„çˆ¬å–åŠŸèƒ½ã€‚

æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬çš„å¯¹è±¡å§‹ç»ˆæ˜¯ç½‘é¡µæœ¬èº«ã€‚è¿™é‡Œå¹¶ä¸å­˜åœ¨ä¸€ä¸ªç»Ÿä¸€çš„ APIï¼Œå¯ä»¥ä¸€æ¬¡æ€§ç›´æ¥è·å–åˆ°æ‰€éœ€çš„æ•°æ®ï¼ˆä¾‹å¦‚æŸç½‘ç«™çš„æ”¶è—å†…å®¹ï¼‰ã€‚ä¸€åˆ‡éƒ½æ˜¯ **æ‰€è§å³æ‰€å¾—** â€”â€”æˆ‘ä»¬æ‰€è¦åšçš„ï¼Œå°±æ˜¯æŠ“å–é¡µé¢æ•°æ®å¹¶å°†ç»“æœæå–å‡ºæ¥ã€‚

ä¸ºäº†å¿«é€Ÿä¸Šæ‰‹ï¼Œè®©æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ä½¿ç”¨è‡ªåŠ¨åŒ–çˆ¬å–æ—¶éœ€è¦è€ƒè™‘çš„å‡ ä¸ªå…³é”®é—®é¢˜ï¼š

* **ä½ éœ€è¦çš„æ•°æ®æ˜¯ä»€ä¹ˆï¼Ÿ**
* **å“ªäº›é¡µé¢åŒ…å«è¿™äº›æ•°æ®ï¼Ÿ**
* **æ˜¯å¦éœ€è¦ç™»å½•ï¼Ÿ**ï¼ˆæœ‰äº›ç½‘ç«™æ— éœ€ç™»å½•ï¼Œå¯è·³è¿‡ï¼‰

  * ç™»å½•å…¥å£åœ¨å“ªé‡Œï¼Ÿ
  * ç™»å½•æ–¹å¼æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆç›®å‰ä»…æ”¯æŒæ‰‹åŠ¨ç™»å½•ï¼‰
  * å¦‚ä½•åˆ¤æ–­ç™»å½•æˆåŠŸï¼Ÿ
* **ç™»å½•æˆåŠŸåï¼Œå¦‚ä½•è¿›å…¥ç›®æ ‡é¡µé¢ï¼Ÿ**

  * ç›®æ ‡é¡µé¢åœ°å€æ˜¯ä»€ä¹ˆï¼Ÿ
* æ‰“ç®—ç”¨å“ªç§æ–¹å¼æ¥çˆ¬å–æ•°æ®ï¼Ÿ

  * **ç›‘å¬ç½‘ç»œå“åº”ï¼ˆæ¨èï¼‰**

    * ç›®æ ‡æ•°æ®åœ¨å“ªä¸ª API è¯·æ±‚é‡Œï¼Ÿï¼ˆå»ºè®®å…¨å±€æœç´¢ï¼Œå¾ˆå¿«èƒ½æ‰¾åˆ°ï¼‰
    * å¦‚ä½•ç›‘å¬ç›®æ ‡ APIï¼Ÿ
    * å¦‚ä½•è§£æ API è¿”å›çš„æ•°æ®ï¼Ÿ
  * **è§£æ DOMï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰**

    * å¦‚ä½•ä»é¡µé¢å…ƒç´ ä¸­æå–æ•°æ®ï¼Ÿ

å½“æˆ‘ä»¬éœ€è¦æŠŠçˆ¬è™«æ‰©å±•æˆä¸€ä¸ª **æ’ä»¶/æœåŠ¡** æ—¶ï¼Œè¿˜è¦è¿›ä¸€æ­¥æ€è€ƒï¼š

* æ˜¯å¦éœ€è¦è®©ç”¨æˆ·è¾“å…¥å‚æ•°ï¼Ÿï¼ˆå¦‚ï¼šæŒ‡å®šæŸä¸ªåšä¸»çš„ç¬”è®°ï¼‰
* å“ªäº›å‚æ•°éœ€è¦ç”¨æˆ·æä¾›ï¼Ÿï¼ˆå¦‚ï¼šåšä¸» IDï¼‰
* å‚æ•°è¯¥å¦‚ä½•å®šä¹‰ä¸ä½¿ç”¨ï¼Ÿï¼ˆæœ¬é¡¹ç›®å·²æä¾›æœ€ä½³å®è·µï¼‰

---

### é¡¹ç›®ä¸­å°šæœªå®ç°ä½†å€¼å¾—æ¢ç´¢çš„é—®é¢˜

* é¡µé¢æ˜¯å¦æ”¯æŒå¤ç”¨ï¼Ÿå¦‚ä½•ä¼˜åŒ–å¤ç”¨èƒ½åŠ›ï¼Ÿ
* Cookie ç®¡ç†æ˜¯å¦å¯ä»¥æ›´ç»†è‡´ï¼Ÿå“ªäº›å­—æ®µæœ€å…³é”®ï¼Ÿ
* æ˜¯å¦éœ€è¦å‰ç«¯ç›‘æ§ç•Œé¢ï¼Ÿ
* èƒ½å¦æ”¯æŒåœ¨æµè§ˆå™¨ç›´æ¥è¿è¡Œï¼Ÿï¼ˆè®©æ²¡æœ‰ç”µè„‘çš„ç”¨æˆ·ä¹Ÿèƒ½ä½¿ç”¨ï¼‰
* æ›´å¤š **AI æ’ä»¶** çš„æ¥å…¥ï¼Œä»¥å¢å¼ºæ•°æ®å¤„ç†èƒ½åŠ›ï¼š
  * å›¾ç‰‡ OCR
  * æ–‡æœ¬æŠ½å–ï¼ˆLangExtractï¼‰
  * æ·±åº¦ç ”ç©¶ï¼ˆDeep Researchï¼‰
  * â€¦â€¦

---

æˆ‘ä»¬çš„ç›®æ ‡å¹¶ä¸æ˜¯åœç•™åœ¨â€œæ•°æ®é‡‡é›†â€å±‚é¢ï¼Œè€Œæ˜¯æ‰“é€ ä¸€ä¸ª **æ•°æ®åŸºç¡€å±‚**ï¼šè®©æ•°æ®ä¸å†å­¤ç«‹åœ¨ä¸åŒå¹³å°ï¼Œè€Œæ˜¯èƒ½é€šè¿‡äºŒæ¬¡æ¥å£ç»Ÿä¸€å±•ç°ã€‚

æƒ³ä¸€æƒ³ï¼Œä½ æ¯å¤©è¦æ‰“å¼€å¤šå°‘ä¸ªç½‘é¡µã€å¤šå°‘ä¸ª Appï¼Ÿä½ æ›¾ç»æ”¶è—è¿‡çš„å†…å®¹åˆæœ‰å¤šä¹…æ²¡æœ‰å†çœ‹è¿‡ï¼Ÿ

æœªæ¥æ›´é‡è¦çš„ï¼Œä¸ä»…æ˜¯â€œèƒ½ä¸èƒ½æ‹¿åˆ°æ•°æ®â€ï¼Œè€Œæ˜¯ **å¦‚ä½•ç”¨å¥½è¿™äº›æ•°æ®**ã€‚AI ä»£è¡¨ç€æ›´å…ˆè¿›çš„ç”Ÿäº§åŠ›ï¼šåœ¨æ•°æ®é‡‡é›†ä¹‹ä¸Šï¼Œå¦‚ä½•è¿›ä¸€æ­¥ **åˆ†æã€æ€»ç»“ã€è½¬åŒ–ä¸ºä»·å€¼**ï¼Œæ‰æ˜¯æ›´å€¼å¾—æ¢ç´¢çš„æ–¹å‘ã€‚


## 2. ä¸ºä»€ä¹ˆéœ€è¦åšæ’ä»¶ï¼ˆPluginï¼‰/æœåŠ¡ï¼ˆServiceï¼‰åˆ†å±‚
æˆ‘æ˜¯è¿™æ ·å®šä¹‰Pluginå’ŒServiceçš„
* Pluginï¼šå®ƒå¯ä»¥ç®¡ç†ä¸€ä¸ªæˆ–å¤šä¸ªServiceï¼Œä¸»è¦çš„èŒè´£æ˜¯æ¨è¿›æœåŠ¡çš„è¿è¡Œï¼Œè´Ÿè´£æ§åˆ¶ï¼š
  * åº”è¯¥æ‰“å¼€å“ªä¸ªé¡µé¢ï¼Ÿ
  * å¦‚ä½•ä¸ç”¨æˆ·æä¾›çš„å‚æ•°ä½œé…åˆï¼Œè¿›å…¥åˆ°éœ€è¦çš„é¡µé¢ï¼Ÿ
  * æœåŠ¡æ¨è¿›çš„é€Ÿåº¦åº”è¯¥æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ
  * ç®¡æ§ç€æœåŠ¡çš„çˆ¬å–å‘¨æœŸï¼ˆé€šè¿‡Delegateï¼‰
  * ä»€ä¹ˆæƒ…å†µä¸‹åº”è¯¥ä¼˜é›…çš„å…³é—­æœåŠ¡ï¼Ÿ
  * ç­‰ç­‰å„ç§æ¯”è¾ƒå¤§çš„é—®é¢˜
* Serviceï¼šå®ƒä¸»è¦è´Ÿè´£æŸä¸€ä¸ªç»†å¾®ç‚¹çš„æ‰§è¡Œï¼Œ
  * ç›‘å¬ä¸€ä¸ªç½‘ç»œå“åº”
  * è´Ÿè´£å°†apiæ•°æ®è§£ææˆéœ€è¦çš„æ ¼å¼

è¿™æ ·è®¾è®¡ä¹‹ä¸‹ï¼Œæœ‰å‡ ä¸ªå¥½å¤„ï¼š
* èŒè´£æ¸…æ™°ã€æ˜ç¡®ï¼Œä¸šåŠ¡ä¸å®¹æ˜“æ··ä¹±
* Serviceå…·å¤‡å¤ç”¨çš„æ½œåŠ›

## 3. ä»0å¼€å§‹å¼€å‘æ’ä»¶

å»¶ç»­å‰é¢çš„æ€è·¯ï¼Œæˆ‘ä»¬æ¥å®é™…èµ°ä¸€éæ’ä»¶å¼€å‘æµç¨‹ã€‚æ¥ä¸‹æ¥ä»¥ **å°çº¢ä¹¦æ”¶è—ç¬”è®°è·å–æ’ä»¶** ä¸ºä¾‹ï¼Œå¸¦å¤§å®¶ä»é›¶å¼€å§‹æ„å»ºã€‚æˆ‘ä»¬çš„æ’ä»¶ä»£ç æ”¾åœ¨ `src/plugins/xiaohongshu` ç›®å½•ä¸‹ã€‚

---

### 3.1 æ˜ç¡®æ•°æ®éœ€æ±‚

é¦–å…ˆè¦è§£å†³çš„é—®é¢˜æ˜¯ï¼š**æˆ‘ä»¬åˆ°åº•éœ€è¦å“ªäº›æ•°æ®ï¼Ÿ**

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯è·å–å°çº¢ä¹¦æ”¶è—ç¬”è®°çš„ **è¯¦ç»†ä¿¡æ¯**ã€‚æ‰€ä»¥ç¬¬ä¸€æ­¥ï¼Œå°±æ˜¯å®šä¹‰æ¸…æ™°çš„æ•°æ®éœ€æ±‚ã€‚

åˆ›å»ºæ–‡ä»¶ `src/services/xiaohongshu/models.py`ï¼ˆä¸ºä¿è¯å¤ç”¨æ€§ï¼Œæœ¬é¡¹ç›®å°†å…¶å®é™…æ”¾åœ¨ `src/services/models.py`ï¼‰ã€‚

```python
@dataclass
class UserInfo:
    user_id: str
    username: str
    avatar: str
    xsec_token: Optional[str] = None
    gender: Optional[str] = None
    is_following: Optional[bool] = None
    is_followed: Optional[bool] = None
    user_type: Optional[str] = None


@dataclass
class AuthorInfo(UserInfo):
    pass


@dataclass
class NoteStatistics:
    like_num: str      # ç‚¹èµæ•°é‡
    collect_num: str   # æ”¶è—æ•°é‡
    chat_num: str      # è¯„è®ºæ•°é‡


@dataclass
class VideoInfo:
    duration_sec: int
    src: str
    id: str


@dataclass
class NoteDetailsItem(WithRaw):
    id: str
    xsec_token: str
    title: str
    desc: str
    author_info: AuthorInfo
    tags: List[str]
    date: str
    ip_zh: str
    comment_num: str
    statistic: NoteStatistics
    images: Optional[list[str]]
    video: Optional[VideoInfo]
    timestamp: str
```

è§„åˆ™å¾ˆç®€å•ï¼šéœ€è¦ä»€ä¹ˆæ•°æ®ï¼Œå°±å®šä¹‰ä»€ä¹ˆå­—æ®µã€‚

---

### 3.2 å“ªäº›é¡µé¢åŒ…å«æ•°æ®

è¿™ä¸ªé—®é¢˜å¹¶ä¸å¤æ‚ã€‚å°çº¢ä¹¦æ”¶è—é¡µé¢å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„å…¥å£ï¼Œç›¸ä¿¡å¤§å®¶éƒ½å¾ˆç†Ÿæ‚‰ã€‚

---

### 3.3 æ˜¯å¦éœ€è¦ç™»å½•

* **ç™»å½•å…¥å£**ï¼š [https://www.xiaohongshu.com/login](https://www.xiaohongshu.com/login)
* **ç™»å½•æ–¹å¼**ï¼šæ‰‹åŠ¨æ‰«ç ç™»å½•ï¼Œç™»å½•æ€æœ‰æ•ˆæœŸè¾ƒé•¿ï¼Œå¯ä»¥åå¤ä½¿ç”¨ã€‚
* **å¦‚ä½•åˆ¤æ–­ç™»å½•æˆåŠŸï¼Ÿ**
  ç™»å½•æˆåŠŸåä¼šè·³è½¬åˆ°é¦–é¡µï¼Œç”¨æˆ·å¤´åƒä¼šæ˜¾ç¤ºå‡ºæ¥ã€‚æˆ‘ä»¬é€‰æ‹©å¤´åƒå…ƒç´ çš„é€‰æ‹©å™¨ `.reds-img-box` æ¥ä½œä¸ºç™»å½•æˆåŠŸçš„åˆ¤æ–­ä¾æ®ã€‚

---

### 3.4 ç™»å½•æˆåŠŸåï¼Œå¦‚ä½•è¿›å…¥ç›®æ ‡é¡µé¢

å°çº¢ä¹¦çš„ç”¨æˆ·ç•Œé¢ URL æ ¼å¼ä¸­åŒ…å« **ç”¨æˆ· ID**ã€‚è™½ç„¶æˆ‘ä»¬å¯ä»¥é€šè¿‡ç›‘å¬ API æ¥è·å–ï¼Œä½†å¯¹äºåªéœ€è¦ä¸€ä¸ª ID çš„åœºæ™¯æ¥è¯´æœ‰äº›ç¹çã€‚äºæ˜¯æˆ‘ä»¬é‡‡ç”¨æ›´ç›´æ¥çš„æ–¹å¼ï¼šç”¨ **Playwright æ§åˆ¶æŒ‰é’®ç‚¹å‡»**ã€‚

1. ç‚¹å‡»ç”¨æˆ·å¤´åƒï¼Œè¿›å…¥ç”¨æˆ·ä¸ªäººé¡µé¢ã€‚
2. å†ç‚¹å‡»â€œæ”¶è—â€ï¼Œè¿›å…¥æ”¶è—æ ‡ç­¾é¡µã€‚

---

### 3.5 çˆ¬å–æ•°æ®çš„æ–¹å¼

è¿›å…¥æ”¶è—é¡µåï¼Œæ‰“å¼€å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰ï¼Œåˆ‡æ¢åˆ° **ç½‘ç»œ (Network)** æ ‡ç­¾ï¼Œå†åˆ·æ–°é¡µé¢ï¼Œå°±èƒ½æ‰¾åˆ°ä¸€ä¸ª API â€”â€”å®ƒè¿”å›äº†æ”¶è—ç¬”è®°çš„ **ç®€ç•¥ä¿¡æ¯**ã€‚

è¿™æ—¶å€™é—®é¢˜æ¥äº†ï¼š
ç®€ç•¥ä¿¡æ¯ â‰  è¯¦ç»†ä¿¡æ¯ã€‚
è¦æ‹¿åˆ°å®Œæ•´å†…å®¹ï¼Œå°±å¾—é€æ¡ç‚¹å¼€ç¬”è®°è¯¦æƒ…ï¼Œè¿™æ ·ä¸€æ¥å°±éœ€è¦å¤„ç† DOMï¼Œå†™èµ·æ¥å¾ˆç¹çã€‚

ä½†æ˜¯ï¼Œç¨å¾®åˆ†æä¸€ä¸‹ URL è§„åˆ™ï¼Œå°±èƒ½æ‰¾åˆ°æ›´ä¼˜è§£ï¼š

ç¬”è®°è¯¦æƒ…é¡µ URL æ ¼å¼ï¼š

```
https://www.xiaohongshu.com/explore/{noteId}?xsec_token={NoteXSecToken}&xsec_source=pc_feed
```

ä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¦æ‹¿åˆ° **noteId** å’Œ **xsec\_token**ï¼Œå°±èƒ½æ‹¼å‡ºç¬”è®°è¯¦æƒ…é¡µçš„åœ°å€ã€‚å¹¸è¿çš„æ˜¯ï¼Œè¿™ä¸¤ä¸ªå‚æ•°æ­£å¥½åŒ…å«åœ¨ç®€ç•¥ä¿¡æ¯é‡Œã€‚

å› æ­¤ï¼Œç­–ç•¥ç«‹åˆ»è°ƒæ•´ä¸º **ä¸¤æ­¥èµ°**ï¼š

1. è·å–æ”¶è—ç¬”è®°çš„ç®€ç•¥ä¿¡æ¯ã€‚
2. æ ¹æ®ç®€ç•¥ä¿¡æ¯ä¸­çš„ `noteId` å’Œ `xsec_token`ï¼Œå†å»è·å–å¯¹åº”çš„è¯¦ç»†ä¿¡æ¯ã€‚

è¿™æ ·ä¸ä»…æ›´é«˜æ•ˆï¼Œè¿˜èƒ½é¿å…å¤æ‚çš„ DOM æ“ä½œã€‚

---

### 3.6 æœ€ç»ˆè§„åˆ’

æˆ‘ä»¬éœ€è¦å¼€å‘ä¸¤ä¸ªæ’ä»¶ï¼š

1. **æ”¶è—ç¬”è®°ç®€ç•¥ä¿¡æ¯æ’ä»¶** â€”â€”è·å–æ”¶è—ç¬”è®°çš„åŸºç¡€ä¿¡æ¯ï¼ˆå« noteId å’Œ xsec\_tokenï¼‰ã€‚
2. **ç¬”è®°è¯¦æƒ…ä¿¡æ¯æ’ä»¶** â€”â€”åˆ©ç”¨ç®€ç•¥ä¿¡æ¯ä¸­çš„å‚æ•°ï¼ŒæŠ“å–ç¬”è®°çš„å®Œæ•´å†…å®¹ã€‚

> ä¸ºä»€ä¹ˆä¸æ˜¯ä¸¤ä¸ªç‹¬ç«‹æœåŠ¡ï¼Ÿ
> å› ä¸ºæ’ä»¶å¯ä»¥æ›´å¿«è¿­ä»£ï¼Œæ—¶é—´æˆæœ¬æ›´ä½ã€‚åŒæ—¶ï¼Œé”™è¯¯æ¢å¤ç­‰é—®é¢˜å¯ä»¥æ”¾åœ¨æ›´é«˜å±‚å»åšã€‚


ä¸‹ä¸€èŠ‚å¼€å§‹ï¼Œæˆ‘ä»¬æ­£å¼è¿›è¡Œæ’ä»¶çš„å¼€å‘
---

## æ”¶è—ç¬”è®°çš„ç®€ç•¥ä¿¡æ¯æ’ä»¶

ç®€ç•¥ä¿¡æ¯æœ¬èº«å°±æ˜¯ä¸€ä¸ªæ–°çš„æ•°æ®éœ€æ±‚ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å…ˆä¸ºå®ƒå®šä¹‰æ•°æ®ç»“æ„ã€‚

```python
@dataclass
class NoteBriefItem(WithRaw):
    id: str
    xsec_token: str
    title: str
    author_info: AuthorInfo
    statistic: NoteStatistics
    cover_image: str
```

å®šä¹‰å¥½æ•°æ®æ¨¡å‹ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ç€æ‰‹ç¼–å†™ Service é€»è¾‘ã€‚åˆ›å»ºæ–‡ä»¶ï¼š
`src/services/xiaohongshu/note_brief_net.py`

åœ¨ Service ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä¾æ¬¡è§£å†³å‡ ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š

1. **ç›‘å¬å“ªä¸ª APIï¼Ÿå¦‚ä½•ç›‘å¬ï¼Ÿ**
2. **å¦‚ä½•è§£æå‡ºéœ€è¦çš„æ•°æ®ï¼Ÿ**

---

#### 1. å¦‚ä½•ç›‘å¬ API

é¡¹ç›®ä¸­å·²ç»å°è£…å¥½äº†ä¸€ä¸ªå·¥å…·ç±» `net_helper.py`ï¼Œä½äº
`src/services/net_consume_helpers.py`ã€‚

å®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿå®Œæˆ **ç½‘ç»œè¯·æ±‚ç›‘å¬ + æ•°æ®æ¶ˆè´¹**ï¼Œä¸‹é¢ç»™å‡ºä¸€ä¸ªä½¿ç”¨ç¤ºä¾‹ï¼š

```python
class XiaohongshuNoteBriefNetService(NetService[NoteBriefItem]):
    """
    å°çº¢ä¹¦ç€‘å¸ƒæµç¬”è®°æŠ“å–æœåŠ¡ - é€šè¿‡ç›‘å¬ç½‘ç»œå®ç°ï¼Œè€Œéè§£æ Dom
    """
    def __init__(self) -> None:
        super().__init__()

    async def attach(self, page: Page) -> None:
        self.page = page
        self.state = NetCollectionState[NoteBriefItem](page=page, queue=asyncio.Queue())

        # å®ä¾‹åŒ– NetConsumeHelperï¼Œä¼ å…¥ state å’Œå›è°ƒ delegate
        self._net_helper = NetConsumeHelper(state=self.state, delegate=self.delegate)

        # ç»‘å®šè¦ç›‘å¬çš„ API
        await self._net_helper.bind(page, [
            (r".*/note/collect/page/*", "response"),
        ])

        # å¯åŠ¨ç›‘å¬å¹¶ä¼ å…¥è§£æå‡½æ•°
        await self._net_helper.start(default_parse_items=self._parse_items_wrapper)

        await super().attach(page)

    async def _parse_items_wrapper(self,
                                   payload: Dict[str, Any],
                                   consume_count: int,
                                   extra: Dict[str, Any],
                                   state: Any) -> List[NoteBriefItem]:
        items_payload = payload.get("data").get("notes", [])
        return parse_brief_from_network(items_payload, raw_data=self._inject_raw_data(payload))
```

**è¯´æ˜ï¼š**

* `self._net_helper = NetConsumeHelper(...)`ï¼šè´Ÿè´£æ³¨å†Œç½‘ç»œç›‘å¬é€»è¾‘ã€‚
* `bind(...)`ï¼šå®šä¹‰ç›‘å¬è§„åˆ™ï¼Œè¿™é‡Œä½¿ç”¨æ­£åˆ™ `r".*/note/collect/page/*"` æ¥åŒ¹é…æ”¶è— APIï¼Œå¹¶æŒ‡å®šç›‘å¬ **å“åº”** è€Œä¸æ˜¯è¯·æ±‚ã€‚
* `start(...)`ï¼šçœŸæ­£å¯åŠ¨ç›‘å¬ï¼Œå¹¶æŒ‡å®šé»˜è®¤è§£æå‡½æ•° `_parse_items_wrapper`ã€‚

---

#### 2. ä¸ºä»€ä¹ˆéœ€è¦ run\_network\_collectionï¼Ÿ

è™½ç„¶ç½‘ç»œç›‘å¬å·²ç»å®Œæˆï¼Œä½† Service å¹¶æ²¡æœ‰ç»“æŸã€‚æˆ‘ä»¬è¿˜éœ€è¦å®ç° `invoke` æ–¹æ³•ï¼š

```python
class XiaohongshuNoteBriefNetService(NetService[NoteBriefItem]):
    """
    å°çº¢ä¹¦ç€‘å¸ƒæµç¬”è®°æŠ“å–æœåŠ¡ - é€šè¿‡ç›‘å¬ç½‘ç»œå®ç°ï¼Œè€Œéè§£æ Dom
    """

    async def invoke(self, extra_params: Dict[str, Any]) -> List[NoteBriefItem]:
        if not self.page or not self.state:
            raise RuntimeError("Service not attached to a Page")

        pause = self._service_params.scroll_pause_ms
        on_scroll = ScrollHelper.build_on_scroll(
            self.page,
            service_params=self._service_params,
            pause_ms=pause,
            extra=extra_params
        )

        items = await run_network_collection(
            self.state,
            self._service_params,
            extra_params=extra_params or {},
            on_scroll=on_scroll,
            delegate=self.loop_delegate,
        )
        return items
```

`invoke` æ–¹æ³•ä¾›æ’ä»¶è°ƒç”¨ï¼Œå®ƒæ¥æ”¶å‚æ•°å¹¶è¿”å›ä¸€ä¸ªæ•°æ®åˆ—è¡¨ã€‚
å…¶æ ¸å¿ƒä¾èµ–æ˜¯ `run_network_collection`ï¼Œå®ƒçš„ä½œç”¨æ˜¯ï¼š

* **ä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼Ÿ**

  * é¡¹ç›®é‡‡ç”¨ **åç¨‹** å®ç°ï¼Œä¸»åç¨‹æ‰§è¡Œ`run_network_collection`ï¼Œè€Œç›‘å¬ API çš„é€»è¾‘è¿è¡Œåœ¨å¦ä¸€ä¸ªåç¨‹å¾ªç¯ä¸­ï¼Œè€Œ `invoke` éœ€è¦åŒæ­¥æ‹¿åˆ°æ•°æ®ã€‚
  * ä¸ºäº†æ¡¥æ¥ä¸¤è€…ï¼Œ`run_network_collection` ä¼šæ–°å¼€ä¸€ä¸ª loop æ¥æ¶ˆè´¹é˜Ÿåˆ—æ•°æ®ã€‚
* **å¦‚ä½•é…åˆï¼Ÿ**

  * ç½‘ç»œç›‘å¬åç¨‹æŠŠæŠ“åˆ°çš„æ•°æ®å¡å…¥ `asyncio.Queue`ã€‚
  * `run_network_collection` åˆ™æŒç»­ä»é˜Ÿåˆ—ä¸­å–æ•°æ®ï¼Œä¸€æ—¦æœ‰æ•°æ®ï¼Œå°±ç«‹å³è§¦å‘è§£æå’Œå¤„ç†ã€‚

è¿™ä¸¤ä¸ªå¾ªç¯ï¼ˆç›‘å¬å¾ªç¯ + æ¶ˆè´¹å¾ªç¯ï¼‰æ˜¯æœ¬é¡¹ç›®çš„ **æ ¸å¿ƒæœºåˆ¶**ï¼Œç†è§£äº†å®ƒï¼Œæ•´ä¸ª Service çš„æ‰§è¡Œæ¨¡å‹å°±æ¸…æ™°äº†ã€‚

---

ğŸ“Œ **æ€»ç»“æµç¨‹**

**æ•°æ®æµè½¬ï¼šç½‘ç»œç›‘å¬ â†’ æ•°æ®å…¥é˜Ÿ â†’ run\_network\_collection æ¶ˆè´¹é˜Ÿåˆ— â†’ invoke è¿”å›ç»“æœ**



ğŸ‘Œ å¥½çš„ï¼Œæˆ‘å¸®ä½ æŠŠè¿™ä¸€éƒ¨åˆ†æ¶¦è‰²æˆ **æ¸…æ™°ã€ç»“æ„åŒ–çš„æŠ€æœ¯è¯´æ˜**ï¼Œæ—¢ä¿æŒåŸæ„ï¼Œåˆè®©å¼€å‘è€…è¯»èµ·æ¥æ›´é¡ºç•…ï¼š

---

### æ•°æ®è§£æé€»è¾‘

å½“ç½‘ç»œæ•°æ®åˆ°æ¥åï¼Œä¸‹ä¸€æ­¥å°±æ˜¯**è§£æå“åº”å†…å®¹**ã€‚
é€šè¿‡åˆ†æ API çš„ JSON æ ¼å¼ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°å†™å‡ºæ•°æ®è§£æå‡½æ•°ï¼š

```python
def parse_brief_from_network(resp_items: List[Dict[str, Any]], raw_data: Any) -> List[NoteBriefItem]:
    """
    ä»ç½‘ç»œå“åº”ä¸­è§£æç¬”è®°ç®€è¦ä¿¡æ¯

    Args:
        resp_items: ç½‘ç»œå“åº”ä¸­çš„ç¬”è®°åˆ—è¡¨
        raw_data: åŸå§‹æ•°æ®

    Returns:
        List[NoteBriefItem]: è§£æåçš„ç¬”è®°ç®€è¦ä¿¡æ¯åˆ—è¡¨
    """
    results: List[NoteBriefItem] = []
    for note_item in resp_items or []:
        try:
            id = note_item["note_id"]
            title = note_item.get("display_title")
            xsec_token = note_item.get("xsec_token")

            # ä½œè€…ä¿¡æ¯
            user = note_item.get("user", {})
            author_info = AuthorInfo(
                username=user.get("nickname"),
                avatar=user.get("avatar"),
                user_id=user.get("user_id"),
                xsec_token=user.get("xsec_token"),
            )

            # äº’åŠ¨æ•°æ®
            interact = note_item.get("interact_info", {})
            statistic = NoteStatistics(
                like_num=str(interact.get("liked_count", 0)),
                collect_num=None,
                chat_num=None,
            )

            # å°é¢å›¾
            cover_image = note_item.get("cover", {}).get("url_default")

            # å°è£…ä¸º NoteBriefItem
            results.append(
                NoteBriefItem(
                    id=id,
                    xsec_token=xsec_token,
                    title=title,
                    author_info=author_info,
                    statistic=statistic,
                    cover_image=cover_image,
                    raw_data=note_item,
                )
            )
        except Exception as e:
            logger.error(f"è§£æç¬”è®°ä¿¡æ¯å‡ºé”™ï¼š{str(e)}")
    return results
```

ç›¸æ¯” DOM è§£æï¼Œè¿™ç§æ–¹å¼æ›´åŠ ç›´è§‚å’Œç¨³å®šï¼Œæå¤§é™ä½äº†è§£æéš¾åº¦ã€‚

---

### æ’ä»¶å¼€å‘

å®Œæˆ Service åï¼Œä¸‹ä¸€æ­¥å°±æ˜¯ç¼–å†™æ’ä»¶ã€‚
æ–°å»ºæ–‡ä»¶ï¼š
`src/plugins/xiaohongshu/xiaohongshu_favorites_brief.py`

#### æ’ä»¶åŸºæœ¬å®šä¹‰

```python
class XiaohongshuNoteBriefPlugin(BasePlugin):

    # æ’ä»¶å”¯ä¸€æ ‡è¯†
    PLUGIN_ID: str = PLUGIN_ID
    PLUGIN_NAME: str = __name__
    PLUGIN_VERSION: str = "2.0.0"
    PLUGIN_DESCRIPTION: str = f"Xiaohongshu note brief info plugin (service-based v{PLUGIN_VERSION})"
    PLUGIN_AUTHOR: str = ""

    # å¹³å° / ç™»å½•é…ç½®ï¼ˆä¾› BasePlugin çš„é€šç”¨ç™»å½•é€»è¾‘ä½¿ç”¨ï¼‰
    LOGIN_URL = "https://www.xiaohongshu.com/login"
    PLATFORM_ID = "xiaohongshu"
    LOGGED_IN_SELECTORS = [
        ".reds-img-box",
    ]
```

å…¶ä¸­ `LOGIN_URL`ã€`PLATFORM_ID`ã€`LOGGED_IN_SELECTORS` å¹¶éä»…ä»…æ˜¯è¯´æ˜ä¿¡æ¯ï¼Œå®ƒä»¬ä¼šè¢« **login\_helper** ä½¿ç”¨ã€‚
login\_helper å¯¹ç™»å½•æµç¨‹è¿›è¡Œäº†ç®€å•å°è£…ï¼Œæ’ä»¶åªéœ€æä¾›å°‘é‡é…ç½®ï¼Œå³å¯å®Œæˆï¼š

* ç™»å½•æ£€æµ‹
* Cookie æ³¨å†Œ
* ç™»å½•æ€ä¿æŒ

---

#### fetchï¼šæ’ä»¶çš„å…¥å£æ–¹æ³•

æ¯ä¸ªæ’ä»¶å¿…é¡»å®ç° `fetch` æ–¹æ³•ï¼Œå®ƒæ˜¯æ’ä»¶è¿è½¬çš„èµ·ç‚¹ï¼š

```python
async def fetch(self) -> Dict[str, Any]:

    await self._ensure_logged_in()
    self._note_brief_net_service.set_params(self.task_params.extra)
    try:
        # åŠ è½½å†å²å­˜å‚¨ï¼ˆé¿å…é‡å¤æŠ“å–ï¼‰
        await self._note_brief_delegate.load_storage_from_data(self.task_params.extra.get("storage_data", {}))

        # æ ¸å¿ƒé€»è¾‘ï¼šæŠ“å–æ”¶è—ç¬”è®°
        briefs_res = await self._collect_briefs()

        if briefs_res["success"]:
            diff = self._note_brief_delegate.get_diff()
            logger.info(f"diff: {diff.stats()}")

            full_data = self._note_brief_delegate.get_storage_data()
            return {
                "success": True,
                "data": full_data,
                "count": len(full_data),
                "plugin_id": self.PLUGIN_ID,
                "version": self.PLUGIN_VERSION,
            }

        raise Exception(briefs_res["error"])

    except Exception as e:
        logger.error(f"Fetch operation failed: {e}")
        return {
            "success": False,
            "error": str(e),
            "data": [],
            "plugin_id": self.PLUGIN_ID,
            "version": self.PLUGIN_VERSION,
        }
```

æ ¸å¿ƒé€»è¾‘ `_collect_briefs`ï¼š

1. ç¡®è®¤å·²ç™»å½•ã€‚
2. è¿›å…¥ç”¨æˆ·æ”¶è—é¡µé¢ã€‚
3. è°ƒç”¨ `note_brief_net_service` å¯åŠ¨ Serviceï¼Œæ”¶é›†ç¬”è®°æ•°æ®ã€‚
4. å°†ç»“æœåºåˆ—åŒ–ä¸º JSONã€‚

```python
async def _collect_briefs(self) -> Dict[str, Any]:
    if not self._note_brief_net_service:
        raise RuntimeError("Services not initialized. Call setup() first.")

    async def goto_favorites():
        await self.page.click('.user, .side-bar-component')
        await asyncio.sleep(1)
        await self.page.click(".sub-tab-list:nth-child(2)")

    try:
        await goto_favorites()
        items = await self._note_brief_net_service.invoke(self.task_params.extra)

        # è½¬æ¢ä¸ºå­—å…¸ï¼Œä¾¿äº JSON è¾“å‡º
        items_data = [asdict(item) for item in items]

        logger.info(f"Successfully collected {len(items_data)} favorite items")

        return {
            "success": True,
            "data": items_data,
            "count": len(items_data),
        }

    except Exception as e:
        ...
```

---

### æ’ä»¶æ³¨å†Œ

æ’ä»¶æœ€åéœ€è¦æ˜¾å¼æ³¨å†Œï¼š

```python
@register_plugin(PLUGIN_ID)
def create_plugin(ctx: PluginContext, params: TaskParams) -> XiaohongshuNoteBriefPlugin:
    p = XiaohongshuNoteBriefPlugin()
    p.inject_task_params(params)
    # æ³¨å…¥ä¸Šä¸‹æ–‡ï¼ˆåŒ…å« page / account_managerï¼‰
    p.set_context(ctx)
    return p
```

è¿™æ ·ï¼Œæ’ä»¶å³å¯è¢«æ¡†æ¶æ­£ç¡®è¯†åˆ«å’ŒåŠ è½½ã€‚

---

ğŸ“Œ **æ€»ç»“æµç¨‹**

* **fetch**ï¼šæ’ä»¶å…¥å£ â†’ ç¡®è®¤ç™»å½• â†’ è°ƒç”¨ `_collect_briefs`
* **\_collect\_briefs**ï¼šè¿›å…¥æ”¶è—é¡µ â†’ è°ƒç”¨ Service â†’ æ”¶é›†å¹¶åºåˆ—åŒ–æ•°æ®
* **Service**ï¼šç›‘å¬ API â†’ è§£æ JSON â†’ è¿”å›ç®€ç•¥ä¿¡æ¯

## ç¬”è®°è¯¦æƒ…ä¿¡æ¯æ’ä»¶


